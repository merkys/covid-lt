#!/bin/bash

# Prepare inputs for Amber calculations

PDB=/dev/stdin
PRMTOP_FILE=
INPCRD_FILE=
SOURCE=

TAR_OUTPUT=false

while [ $# -gt 0 ]
do
    case $1 in
        -p|--prm|--prmtop)
            PRMTOP_FILE="$2"
            shift
            ;;
        -i|-c|--inp|--crd|--inpcrd)
            INPCRD_FILE="$2"
            shift
            ;;
        --source)
            SOURCE="$2"
            shift
            ;;
        --tar|--output-tar)
            TAR_OUTPUT=true
            ;;
        *)
            PDB=$1
            ;;
    esac
    shift
done

TMP_DIR=$(mktemp --directory)

cat $PDB > "${TMP_DIR}"/$(basename $PDB)

(
    cd "${TMP_DIR}"

    echo source $SOURCE >> tleap.in
    echo mol = loadpdb $(basename $PDB) >> tleap.in
    echo saveamberparm mol PRMTOP_FILE INPCRD_FILE >> tleap.in
    echo quit >> tleap.in

    tleap -s -f tleap.in >&2
    cat leap.log >&2
)

EXIT_STATUS=0

if $TAR_OUTPUT
then
    (cd "${TMP_DIR}" && tar -cf /dev/stdout PRMTOP_FILE INPCRD_FILE || EXIT_STATUS=1)
else
    cp "${TMP_DIR}"/PRMTOP_FILE $PRMTOP_FILE || EXIT_STATUS=1
    cp "${TMP_DIR}"/INPCRD_FILE $INPCRD_FILE || EXIT_STATUS=1
fi

rm -rf "${TMP_DIR}"

exit ${EXIT_STATUS}
