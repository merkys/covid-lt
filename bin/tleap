#!/bin/bash

# Prepare inputs for Amber calculations

PDB=
PRMTOP_FILE=
INPCRD_FILE=
SOURCE=

while [ $# -gt 0 ]
do
    case $1 in
        -p|--prm|--prmtop)
            PRMTOP_FILE="$2"
            shift
            ;;
        -i|-c|--inp|--crd|--inpcrd)
            INPCRD_FILE="$2"
            shift
        --source)
            SOURCE="$2"
            shift
        *)
            PDB=$1
            ;;
    esac
    shift
done

TMP_DIR=$(mktemp --directory)

cp $PDB "${TMP_DIR}"

(
    cd "${TMP_DIR}"

    echo source $SOURCE >> tleap.in
    echo mol = loadpdb $(basename $PDB) >> tleap.in
    echo saveamberparm mol PRMTOP_FILE INPCRD_FILE >> tleap.in
    echo quit >> tleap.in

    tleap -s -f tleap.in >&2
    cat leap.log >&2
)

EXIT_STATUS=0

cp "${TMP_DIR}"/PRMTOP_FILE $PRMTOP_FILE || EXIT_STATUS=1
cp "${TMP_DIR}"/INPCRD_FILE $INPCRD_FILE || EXIT_STATUS=1

rm -rf "${TMP_DIR}"

exit ${EXIT_STATUS}
