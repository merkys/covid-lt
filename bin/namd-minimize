#!/bin/bash

# Perform PDB structure minimization using NAMD.
# Configuration file is based on https://www.ks.uiuc.edu/Training/Tutorials/namd/namd-tutorial-html/node26.html
# Useful reference: https://www.ks.uiuc.edu/Research/namd/2.14/ug.pdf

INPUT_PARAMETERS=$1
shift

PARAMETERS_BASE=$(basename $INPUT_PARAMETERS)

TMPDIR=$(mktemp --directory)

cat "$@" > $TMPDIR/input.tar
cp $INPUT_PARAMETERS $TMPDIR/

cat > $TMPDIR/minimize.conf <<END
structure          input.psf
coordinates        input.pdb

set temperature    310; # Normal warm-blooded cell temperature
temperature        \$temperature

paraTypeCharmm     on
parameters         $PARAMETERS_BASE

cutoff             12
switchdist         10

constraints        on
consref            constraints.con
conskfile          constraints.con
conskcol           B

rigidBonds         all; # Use SHAKE to constrain hydrogen-containing bonds

exclude            scaled1-4
outputname         output
binaryoutput       no

minimize           100;           # Minimization steps
reinitvels         \$temperature; # Minimization zeros velocities (?)
END

(
    cd $TMPDIR
    tar -xf input.tar && rm input.tar

    mv *.pdb input.pdb
    mv *.psf input.psf

    grep '^ATOM  ' input.pdb \
        | awk '{print substr($0,0,60)"  5   "substr($0,67)}' > constraints.con

    namd2 minimize.conf >&2

    if [ -e output.coor -a -e output.vel -a -e output.xsc ]
    then
        tar -cf /dev/stdout output.coor output.vel output.xsc
    fi
)

rm -rf $TMPDIR
