#!/usr/bin/env python3

from anarci import run_anarci
from pdbio.pdbfile import PDBFile
from warnings import warn
import argparse, sys

parser = argparse.ArgumentParser()
parser.add_argument('files', nargs='*', default=[sys.stdin])
parser.add_argument('--chain-types', help='List of chain types that should be recognised by ANARCI', default='HL')
parser.add_argument('--debug', action='store_true', help='Turn on debug messages')
args = parser.parse_args()

pdb = PDBFile(args.files[0]) # Only the first file is processed for now

for chain in pdb:
    # The following piece of code is used to renumber residues with insertion codes to plain sequential numbers.
    # This is done as some input files may already be renumbered and such files would only confuse the current script.

    last_seen = None
    def unset_insertion_codes(number, icode):
        global last_seen
        if last_seen and last_seen[0:2] == [number, icode]:
            number_now = last_seen[2]
            return number_now, ' '
        if last_seen and last_seen[0] == number: # Same number, different icode
            number_now = last_seen[2] + 1
            last_seen[1:2] = [icode, number_now]
            return number_now, ' '
        if last_seen == chain: # Same chain
            number_now = last_seen[2] + number - last_seen[0]
            last_seen = [number, icode, number_now]
            return number_now, ' '
        last_seen = [number, icode, number]
        return None, ' '
    chain.renumber(unset_insertion_codes)

    sequence = pdb.sequence(chain.name)
    _, numbered, details, _ = run_anarci([(chain.name, sequence)], scheme='chothia', allow=set(args.chain_types))
    numbered = numbered[0]
    details = details[0]
    if numbered is None:
        continue
    if len(numbered) > 1:
        warn('Chain {} has more than one alignment, renumbering according to the first one found'.format(chain.name))
    numbered = numbered[0][0]
    details = details[0]
    chain_type = details['chain_type'] # To be somehow stored in the resulting PDB file
    if args.debug:
        warn('Chain {} detected as {}'.format(chain.name, chain_type))
    numbered = list(filter(lambda x: x[1] != '-', numbered))

    def renumber_antibody(number, icode):
        if number <= details['query_start']:
            return number - details['query_start'], ' '
        if number > details['query_end']:
            return numbered[-1][0][0] + (number-details['query_end']), ' '
        else:
            return numbered[number-details['query_start']-1][0][0], numbered[number-details['query_start']-1][0][1]

    chain.renumber(renumber_antibody)

print(pdb, end='')
