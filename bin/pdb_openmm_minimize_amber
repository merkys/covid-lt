#!/usr/bin/env python3

# Based on AlphaFold Amber minimization code:
# https://github.com/deepmind/alphafold/blob/197bd19ee371ebac1942951b49a01848d2c9c6fc/alphafold/relax/amber_minimize.py

from simtk import openmm
from simtk.openmm import app as openmm_app
import argparse, sys

def print_forces(system, simulation):
    """
    Based on https://openmm.github.io/openmm-cookbook/dev/notebooks/cookbook/Analyzing%20Energy%20Contributions.html
    """
    state = simulation.context.getState(getEnergy=True, getPositions=True)
    print('PotentialEnergy', state.getPotentialEnergy(), file=sys.stderr)
    # print(state.getPositions(asNumpy=True), file=sys.stderr)
    for i, force in enumerate(system.getForces()):
        state = simulation.context.getState(getEnergy=True, groups={i})
        print(force.__class__.__name__, state.getPotentialEnergy(), file=sys.stderr)

parser = argparse.ArgumentParser()
parser.add_argument('files', nargs='*')
parser.add_argument('--platform', help='Specify the platform to use for the simulation ("Reference" by default)', default='Reference')
parser.add_argument('--forcefield', action='append', help='Specify the forcefield, may be multiple (["amber99sb.xml"] by default)', default=[])
args = parser.parse_args()

forcefields = args.forcefield
if not len(forcefields):
    forcefields = ['amber99sb.xml']

max_iterations = 1
tolerance = 2.39

file = args.files[0] # for now

pdb = openmm_app.PDBFile(file)

force_field = openmm_app.ForceField(*forcefields)
constraints = openmm_app.HBonds

system = force_field.createSystem(pdb.topology, constraints=constraints)
# stiffness omitted here

integrator = openmm.LangevinIntegrator(0, 0.01, 0.0)
platform = openmm.Platform.getPlatformByName(args.platform)
simulation = openmm_app.Simulation(pdb.topology, system, integrator, platform)
simulation.context.setPositions(pdb.positions)

print_forces(system, simulation)

simulation.minimizeEnergy(maxIterations=max_iterations, tolerance=tolerance)

print_forces(system, simulation)

state = simulation.context.getState(getEnergy=True, getPositions=True)
openmm_app.PDBFile.writeFile(simulation.topology, state.getPositions(), sys.stdout)
