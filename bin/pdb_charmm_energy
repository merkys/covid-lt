#!/bin/bash

INPUT_PDB=
INPUT_RTF= # topology
INPUT_PRM= # parameters

PBEQ=

while [ $# -gt 0 ]
do
    case $1 in
        -t|--topology|--topo|--top)
            INPUT_RTF="$2"
            shift
            ;;
        -p|--parameters|--param|--par|--prm)
            INPUT_PRM="$2"
            shift
            ;;
        --pbeq)
            PBEQ=1
            ;;
        -*) echo "`basename $0`: unknown option $1" >&2 ; exit 1 ;;
        *)
            test -z "$INPUT_PDB" && INPUT_PDB=$1
            ;;
    esac
    shift
done

if [ -z "$INPUT_PDB" -o -z "$INPUT_RTF" -o -z "$INPUT_PRM" ]
then
    echo "`basename $0`: either input PDB, or topology, or parameters are missing" >&2
    exit 1
fi

RTF_BASE=$(basename $INPUT_RTF)
PRM_BASE=$(basename $INPUT_PRM)

TMPDIR=$(mktemp --directory)

cp $INPUT_RTF $INPUT_PRM $TMPDIR/
sed 's/HIS/HSD/g' $INPUT_PDB > $TMPDIR/input.pdb

cat > $TMPDIR/energy.inp <<ENDSCRIPT
!Taken from https://www.charmm.org/wiki//index.php/CHARMM:The_Basics
!Read in RTF and Parameter files
OPEN UNIT 1 CARD READ NAME $RTF_BASE
READ RTF CARD UNIT 1
CLOSE UNIT 1

OPEN UNIT 1 CARD READ NAME $PRM_BASE
READ PARA CARD UNIT 1
CLOSE UNIT 1
 
!Read in the pdb
OPEN UNIT 1 CARD READ NAME input.pdb
READ SEQU PDB UNIT 1
 
!Time for CHARMM to make the Internal Coordinates table
GENErate A SETUp
 
REWInd UNIT 1
READ COOR PDB UNIT 1
CLOSE UNIT 1
 
!Involves known atomic coordinates and fills in missing coordinates
IC FILL

!Will retrieve standard coordinates from the parameter file
IC PARAmeters

!Will find the Cartesian coordinates previously unknown
IC BUILd

!Rebuild all hydrogen coordinates
HBUILD SELEct HYDRogen END

!Check for remaining missing atoms
PRINt COOR SELEct .NOT. INITialized END
 
ENERgy
ENDSCRIPT

if [ -n "$PBEQ" ]
then

cat >> $TMPDIR/energy.inp <<ENDSCRIPT
PBEQ
   SOLVE epsw 80 epsp 2 -
        dcel 1.0 -
ENDSCRIPT

pdb_box $TMPDIR/input.pdb | bin/pbeq-mesh >> $TMPDIR/energy.inp

cat >> $TMPDIR/energy.inp <<ENDSCRIPT
        maxi 1000 select all end
END
ENDSCRIPT
fi

echo STOP >> $TMPDIR/energy.inp

(
    cd $TMPDIR
    charmm < energy.inp
)

rm -rf $TMPDIR
