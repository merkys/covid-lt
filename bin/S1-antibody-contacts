#!/bin/bash

PDB_ID=$1

# Taking only the first of S1 chains
S1_CHAIN=$(bin/pdb_compounds pdb/pristine/${PDB_ID}.pdb --hmmsearch pdb_seqres-PF09408.hmmsearch | grep PF09408 | head -n1 | cut -f 2)

# Exit if no S1 chains found
test -z "${S1_CHAIN}" && exit 0

bin/vorocontacts-select --chain ${S1_CHAIN} --exclude-self --dist min vorocontacts/${PDB_ID}.tab \
    | while read C1 R1 C2 R2 DIST
      do
        # FIXME: Filter only the antibody chains
        if [ "${C1}" = "${S1_CHAIN}" ]
        then
            echo -e "${R1}\t${DIST}"
        else
            echo -e "${R2}\t${DIST}"
        fi
      done \
    | sort -nk1.1 \
    | python3 -c '
import re, sys
residues = {}
for line in sys.stdin:
    match = re.match("(\d+)\t(\S+)", line)
    if not match:
        continue
    residue = int(match.group(1))
    dist = float(match.group(2))
    if residue not in residues or dist < residues[residue]:
        residues[residue] = dist
for i in range(1, 1500): # Assuming S1 is max. 1500 aminoacids long
    if i in residues:
        print(residues[i])
    else:
        print("?")
      '
