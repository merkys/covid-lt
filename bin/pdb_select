#!/usr/bin/env python3

# Select chain(s) from a PDB file.

chain_identifiers = {
    'ANISOU': [ 21 ],
    'ATOM  ': [ 21 ],
    'CIPSEP': [ 15, 29 ],
    'DBREF ': [ 12 ],
    'DBREF1': [ 12 ],
    'DBREF2': [ 12 ],
    'HELIX ': [ 19, 31 ],
    'LINK  ': [ 21, 51 ],
    'SHEET ': [ 21, 32, 49, 64 ],
    'SITE  ': [ 22, 33, 44, 55 ],
    'SEQRES': [ 11 ],
    'SSBOND': [ 15, 29 ],
    'TER   ': [ 21 ],
}

model_keywords = { 'ATOM  ', 'HETATM', 'ANISOU', 'TER   ' }

import argparse, re, sys

parser = argparse.ArgumentParser()
parser.add_argument('files', nargs='*')
parser.add_argument('--first-model', action='store_true', help='Select only the first model (if multiple)')
parser.add_argument('--chain', action='append', help='Select certain chain(s), may be multiple')
parser.add_argument('--from-residue', type=int, help='Starting residue number')
parser.add_argument('--backbone', action='store_true', help='Select only the backbone atoms')
args = parser.parse_args()

files = args.files
if len(files) == 0:
    files = [sys.stdin]

model = 1
for file in files:
    if isinstance(file, str):
        file = open(file, 'r')
    compnd = None
    for line in file:
        keyword = line[0:6]
        if keyword == 'COMPND': # Read in COMPND records
            if not compnd:
                compnd = []
            if re.match('COMPND.{4,5}MOL_ID:', line):
                compnd.append({ 'MOLECULE': None, 'CHAIN': set(), 'DATA': [] })
            elif re.match('COMPND.{5}MOLECULE:', line):
                compnd[-1]['MOLECULE'] = line[21:]
            elif re.match('COMPND.{5}CHAIN:', line):
                compnd[-1]['CHAIN'] = set(re.split('\s*,\s*', re.sub('\s*;?\s*\n$', '', line[18:])))
            else:
                compnd[-1]['DATA'].append(line[11:])
            continue
        if compnd: # Formulate new COMPND records
            line_nr = 1
            mol_nr = 1
            for mol in range(len(compnd)):
                if args.chain and set(args.chain).isdisjoint(compnd[mol]['CHAIN']):
                    continue
                if line_nr == 1:
                    print('COMPND    ', end='')
                else:
                    print('COMPND% 4d ' % line_nr, end='')
                print('MOL_ID: %d;' % mol_nr)
                mol_nr += 1
                line_nr += 1

                print('COMPND% 4d MOLECULE: %s' % (line_nr, compnd[mol]['MOLECULE']), end='')
                line_nr += 1

                if args.chain:
                    compnd[mol]['CHAIN'] = compnd[mol]['CHAIN'] & set(args.chain)
                print('COMPND% 4d CHAIN: %s;' % (line_nr, ', '.join(compnd[mol]['CHAIN'])))
                line_nr += 1

                for data_line in compnd[mol]['DATA']:
                    print('COMPND% 4d %s' % (line_nr, data_line), end='')
                    line_nr += 1
            compnd = None
        if keyword == 'MODEL ' and args.first_model:
            model = int(line[10:14])
            continue
        if keyword == 'ENDMDL' and args.first_model:
            continue
        if args.first_model and model != 1 and keyword in model_keywords:
            continue
        if keyword not in chain_identifiers:
            print(line, end='')
            continue
        if args.chain:
            mentioned_chains = set([line[x] for x in chain_identifiers[keyword]])
            if set(args.chain).isdisjoint(mentioned_chains):
                continue
        if args.from_residue is not None and keyword == 'ATOM  ' and int(line[22:26]) < args.from_residue:
            continue
        if args.backbone and keyword == 'ATOM  ' and line[12:16].strip() not in ['C', 'CA', 'N']:
            continue
        print(line, end='')
