#!/usr/bin/env python3

# Rename chains in PDB file.

from io import StringIO
from pdbio.pdbfile import PDBFile
from warnings import filterwarnings
import argparse, re, sys

parser = argparse.ArgumentParser()
parser.add_argument('files', nargs='*')
parser.add_argument('--source', help='A file to take chain names from')
parser.add_argument('--map', action='append', help='Provide two chain names from which to which to rename (may be several)')
parser.add_argument('--align', action='append', help='Provide a single letter, \':\' and file name with FASTA sequence to rename if matches')
parser.add_argument('--identity-threshold', type=float, default=0, help='Specify identity threshold for alignments (default 0)')
parser.add_argument('--guess', action='store_true', help='Attempt to identify heavy and light antibody chains from their descriptions')
args = parser.parse_args()

mapping = None
if args.map:
    mapping = {}
    for pair in args.map:
        mapping[pair[0]] = pair[2]

source_chains = None
if args.source:
    source_pdb = PDBFile(args.source)
    source_chains = source_pdb.chains()

files = args.files
if len(files) == 0:
    files = [sys.stdin]

for target in files:
    if isinstance(target, str):
        target = open(target, 'r')

    target_chains = []
    molecule_descriptions = []
    molecule_chains = []
    handle = StringIO()
    for line in target:
        handle.write(line)
        if line[0:6] == 'ATOM  ':
            chain = line[21]
            if chain not in target_chains:
                target_chains.append(chain)
        if line[0:6] == 'COMPND':
            if line[11:20] == 'MOLECULE:':
                molecule_descriptions.append(line[21:])
            if line[11:17] == 'CHAIN:':
                molecule_chains.append(re.split('\s*,\s*', re.sub('\s*;?\s*\n$', '', line[18:])))
    if mapping is None:
        mapping = dict(zip(target_chains, target_chains))

    if args.align:
        from Bio import PDB, SeqIO
        from subprocess import Popen, PIPE

        filterwarnings('ignore', category=PDB.PDBExceptions.PDBConstructionWarning)

        for alignment in args.align:
            chain = alignment[0]
            child = Popen('blastp -query ' + alignment[2:] + ' -subject - -outfmt "6 sseqid pident"', stdin=PIPE, stdout=PIPE, stderr=PIPE, shell=True, text=True)

            handle.seek(0)
            SeqIO.convert(handle, 'pdb-seqres', child.stdin, 'fasta')
            child.stdin.close() # Do we really need this?
            for line in child.stdout.readlines():
                identity = float(line[7:])
                if identity >= args.identity_threshold:
                    mapping[line[5]] = chain

    if args.guess:
        for description, chains in zip(molecule_descriptions, molecule_chains):
            if re.search('heavy chain', description, re.IGNORECASE):
                for chain in chains:
                    mapping[chain] = 'H'
            if re.search('light chain', description, re.IGNORECASE):
                for chain in chains:
                    mapping[chain] = 'L'

    if source_chains is not None:
        if len(source_chains) != len(target_chains):
            raise Exception('Chain lists are different in size: ' + str(source_chains) + ' and ' + str(target_chains))
        else:
            mapping = dict(zip(target_chains, source_chains))

    renamings = {
        'ANISOU': [ 21 ],
        'ATOM  ': [ 21 ],
        'CIPSEP': [ 15, 29 ],
        'DBREF ': [ 12 ],
        'DBREF1': [ 12 ],
        'DBREF2': [ 12 ],
        'HELIX ': [ 19, 31 ],
        'LINK  ': [ 21, 51 ],
        'SHEET ': [ 21, 32, 49, 64 ],
        'SITE  ': [ 22, 33, 44, 55 ],
        'SEQADV': [ 16 ],
        'SEQRES': [ 11 ],
        'SSBOND': [ 15, 29 ],
        'TER   ': [ 21 ],
    }

    handle.seek(0)
    mapping[' '] = ' '
    for line in handle:
        if line[0:6] in renamings:
            for renaming in renamings[line[0:6]]:
                if line[renaming] in mapping: # Might be a link to HETATM record, see 7Q0H
                    line = line[0:renaming] + mapping[line[renaming]] + line[renaming+1:]
        if line[0:6] == 'COMPND' and line[11:17] == 'CHAIN:':
            line = line[0:17] + line[17:].translate(str.maketrans(mapping))
        print(line, end='')
