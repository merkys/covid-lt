#!/usr/bin/env python3

from Bio.Data.IUPACData import protein_letters_3to1
import argparse, re, sys

parser = argparse.ArgumentParser()
parser.add_argument('files', nargs='*')
parser.add_argument('--map', help='Specify a file providing residue mapping')
args = parser.parse_args()

map = None
if args.map:
    map = {}
    for line in open(args.map, 'r'):
        fields = line.strip().split('\t')
        map[fields[1]] = fields[0].strip()

files = args.files
if len(files) == 0:
    files = [sys.stdin]

def process_mut(match):
    chain, number, aa = match.group(1), match.group(2), match.group(3)
    if map:
        chain = ''
        number = map[number]
    return protein_letters_3to1[aa.capitalize()] + chain + number + ','

for file in files:
    if isinstance(file, str):
        file = open(file, 'r')
    header = re.split(',', file.readline().strip())
    print(','.join(protein_letters_3to1[x.capitalize()] if x.capitalize() in protein_letters_3to1 else x for x in header))
    for line in file:
        print(re.sub('^(.)_(\d+)_(...),', process_mut, line), end='')
