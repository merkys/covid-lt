#!/usr/bin/env python3

from Bio.Data.IUPACData import protein_letters_3to1
import argparse, re, sys

parser = argparse.ArgumentParser()
parser.add_argument('files', nargs='*')
parser.add_argument('--map', help='Specify a file providing residue mapping')
parser.add_argument('--mutation', help='Select a specific mutation')
args = parser.parse_args()

map = None
if args.map:
    map = {}
    for line in open(args.map, 'r'):
        fields = line.strip().split('\t')
        map[fields[1]] = fields[0].strip()

files = args.files
if len(files) == 0:
    files = [sys.stdin]

def process_mut(uep_mutation):
    match = re.match('^(.)_(\d+)_(...)$', uep_mutation)
    chain, number, aa = match.group(1), match.group(2), match.group(3)
    if map:
        chain = ''
        number = map[number]
    return protein_letters_3to1[aa.capitalize()] + chain + number

header = None
for file in files:
    if isinstance(file, str):
        file = open(file, 'r')
    header = re.split(',', file.readline().strip())
    if not args.mutation:
        print(','.join(protein_letters_3to1[x.capitalize()] if x.capitalize() in protein_letters_3to1 else x for x in header))
    for line in file:
        fields = line.strip().split(',')
        fields[0] = process_mut(fields[0])
        if args.mutation:
            if fields[0] != args.mutation[0:-1]:
                continue
            for i, aa in enumerate(header):
                if aa.capitalize() not in protein_letters_3to1:
                    continue
                if protein_letters_3to1[aa.capitalize()] == args.mutation[-1]:
                    print(fields[i])
        else:
            print(*fields, sep=',')
