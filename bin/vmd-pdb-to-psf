#!/bin/bash

# Based on https://www.ks.uiuc.edu/Research/vmd/plugins/psfgen/ug.pdf

INPUT_PDB=
INPUT_TOPOLOGY=

SPLIT_CHAINS_INTO_SEGMENTS=true

while [ $# -gt 0 ]
do
    case $1 in
        -t|--topology|--topo|--top)
            INPUT_TOPOLOGY="$2"
            shift
            ;;
        --no-split-chains-into-segments)
            SPLIT_CHAINS_INTO_SEGMENTS=false
            ;;
        -*) echo "`basename $0`: unknown option $1" >&2 ; exit 1 ;;
        *)
            test -z "$INPUT_PDB" && INPUT_PDB=$1
            ;;
    esac
    shift
done

PDB_BASE=$(basename $INPUT_PDB)
TOPOLOGY_BASE=$(basename $INPUT_TOPOLOGY)

TMPDIR=$(mktemp --directory)

grep -v '^HETATM' $INPUT_PDB > $TMPDIR/$(basename $INPUT_PDB)
cp $INPUT_TOPOLOGY $TMPDIR/

cat > $TMPDIR/vmdgen.pgn <<END
package require psfgen
topology $TOPOLOGY_BASE
pdbalias residue HIS HSE
pdbalias residue MLY LYS
END

for CHAIN in $(pdb_chains $TMPDIR/$(basename $INPUT_PDB) | sort | uniq)
do
    if $SPLIT_CHAINS_INTO_SEGMENTS
    then
        for RANGE in $(bin/pdb_select --first-model --chain $CHAIN $TMPDIR/$(basename $INPUT_PDB) | pdb_listres | tr , ' ')
        do
            SEGNAME=${CHAIN}$(echo $RANGE | cut -d - -f 1)
            bin/pdb_select --first-model --chain $CHAIN --residues=$RANGE $TMPDIR/$(basename $INPUT_PDB) > $TMPDIR/$SEGNAME.pdb
            echo "segment $SEGNAME { pdb $SEGNAME.pdb }" >> $TMPDIR/vmdgen.pgn
            echo "coordpdb $SEGNAME.pdb $SEGNAME" >> $TMPDIR/vmdgen.pgn
        done
    else
        bin/pdb_select --first-model --chain $CHAIN $TMPDIR/$(basename $INPUT_PDB) > $TMPDIR/$CHAIN.pdb
        echo "segment $CHAIN { pdb $CHAIN.pdb }" >> $TMPDIR/vmdgen.pgn
        echo "coordpdb $CHAIN.pdb $CHAIN" >> $TMPDIR/vmdgen.pgn
    fi
done

rm -f $TMPDIR/$(basename $INPUT_PDB)

cat >> $TMPDIR/vmdgen.pgn <<END
guesscoord
writepdb vmd.pdb
writepsf vmd.psf
exit
END

(
    cd $TMPDIR
    VMDDIR=/usr/lib/vmd vmd -dispdev text -e vmdgen.pgn >&2

    mv vmd.pdb $(basename $PDB_BASE .pdb).vmd.pdb
    mv vmd.psf $(basename $PDB_BASE .pdb).vmd.psf

    tar -cf /dev/stdout $(basename $PDB_BASE .pdb).vmd.pdb $(basename $PDB_BASE .pdb).vmd.psf
)

rm -rf $TMPDIR
