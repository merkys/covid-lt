#!/bin/bash

# Based on https://www.ks.uiuc.edu/Research/vmd/plugins/psfgen/ug.pdf

INPUT_PDB=$1
INPUT_TOPOLOGY=$2

PDB_BASE=$(basename $INPUT_PDB)
TOPOLOGY_BASE=$(basename $INPUT_TOPOLOGY)

TMPDIR=$(mktemp --directory)

grep -v '^HETATM' $INPUT_PDB > $TMPDIR/$(basename $INPUT_PDB)
cp $INPUT_TOPOLOGY $TMPDIR/

cat > $TMPDIR/vmdgen.pgn <<END
package require psfgen
topology $TOPOLOGY_BASE
pdbalias residue HIS HSE
END

for CHAIN in $(pdb_chains $TMPDIR/$(basename $INPUT_PDB) | sort | uniq)
do
    for RANGE in $(bin/pdb_select --first-model --chain $CHAIN $TMPDIR/$(basename $INPUT_PDB) | pdb_listres | tr , ' ')
    do
        SEGNAME=${CHAIN}$(echo $RANGE | cut -d - -f 1)
        bin/pdb_select --first-model --chain $CHAIN --residues=$RANGE $TMPDIR/$(basename $INPUT_PDB) > $TMPDIR/$SEGNAME.pdb
        echo "segment $SEGNAME { pdb $SEGNAME.pdb }" >> $TMPDIR/vmdgen.pgn
        echo "coordpdb $SEGNAME.pdb $SEGNAME" >> $TMPDIR/vmdgen.pgn
    done
done

rm -f $TMPDIR/$(basename $INPUT_PDB)

cat >> $TMPDIR/vmdgen.pgn <<END
guesscoord
writepdb vmd.pdb
writepsf vmd.psf
exit
END

(
    cd $TMPDIR
    VMDDIR=/usr/lib/vmd vmd -dispdev text -e vmdgen.pgn >&2

    mv vmd.pdb $(basename $PDB_BASE .pdb).vmd.pdb
    mv vmd.psf $(basename $PDB_BASE .pdb).vmd.psf

    tar -cf /dev/stdout $(basename $PDB_BASE .pdb).vmd.pdb $(basename $PDB_BASE .pdb).vmd.psf
)

rm -rf $TMPDIR
