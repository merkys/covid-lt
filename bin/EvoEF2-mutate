#!/bin/bash

# EvoEF2 needs a wrapper to control the location of output file.

INPUT_PDB=
MUTATION=

while [ $# -gt 0 ]
do
    case $1 in
        --mutation)
            MUTATION="$2"
            shift
            ;;
        -*) echo "`basename $0`: unknown option $1" >&2 ; exit 1 ;;
        *)
            INPUT_PDB=$1
            ;;
    esac
    shift
done

TMPDIR=$(mktemp --directory)

cat $INPUT_PDB > $TMPDIR/input.pdb

MUT_RES=$(echo $MUTATION   | cut -c 1)
MUT_CHAIN=$(echo $MUTATION | cut -c 2)
MUT_POS=$(echo $MUTATION   | grep -o '[0-9]\+' | head -n 1)

if [ "$(bin/pdb_select $TMPDIR/input.pdb --chain $MUT_CHAIN --residues $MUT_POS- | bin/pdb_atom2fasta | grep -v '^>' | head -n 1 | cut -c 1)" != "$MUT_RES" ]
then
    echo $(basename $0): $INPUT_PDB: residue in mutated position does not match the declared one >&2
    exit 1
fi

(
    cd $TMPDIR
    EvoEF2 --command BuildMutant --pdb input.pdb --mutant_file <(echo $MUTATION) >&2
    cat input_Model_0001.pdb
)

rm -rf "$TMPDIR"
